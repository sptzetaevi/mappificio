<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Prenotazione sportello TIC di Carlotta Borghetti</title>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    line-height: 1.4;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 15px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: center;
  }

  th { background: #f0f0f0; }

  /* COLORI STATI */
  .stato-libero {
    background: #e8f5e9;
    color: #1b5e20;
    font-weight: bold;
  }

  .stato-occupato {
    background: #fdecea;
    color: #8e0000;
    font-weight: bold;
  }

  .stato-scaduto {
    background: #fff8e1;
    color: #7a5b00;
    font-weight: bold;
  }

  a { word-break: break-all; }

  button {
    padding: 6px 10px;
    cursor: pointer;
  }

  button[disabled] {
    opacity: .6;
    cursor: not-allowed;
  }

  /* MODALE */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
    padding: 12px;
    z-index: 9999;
  }

  .modal-content {
    background: #fff;
    padding: 18px;
    max-width: 440px;
    width: 100%;
    border-radius: 8px;
  }

  label {
    display: block;
    margin-top: 12px;
    text-align: left;
  }

  input, select {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
    box-sizing: border-box;
  }

  .actions {
    margin-top: 14px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
  }

  .status {
    margin-top: 10px;
    font-size: 14px;
  }

  .error { color: #b00020; }
  .ok { color: #0a7a0a; }

  /* UX: riga di caricamento */
  .loading-row {
    color: #555;
    font-style: italic;
  }
  .small-note {
    margin: 6px 0 0;
    color: #666;
    font-size: 13px;
  }
</style>
</head>

<body>

<h2>Prenotazione sportello TIC di Carlotta Borghetti</h2>

<p>
  Gli slot verdi sono prenotabili, i rossi già prenotati, mentre i gialli indicano appuntamenti non più prenotabili: le prenotazioni chiudono 24 ore prima dell’orario previsto.
</p>
<p class="small-note" id="cacheNote" style="display:none;"></p>

<table id="slots">
  <thead>
    <tr>
      <th>Data</th>
      <th>Ora</th>
      <th>Stato</th>
      <th>Azione</th>
    </tr>
  </thead>
  <tbody>
    <!-- Caricamento immediato (placeholder) -->
    <tr class="loading-row"><td colspan="4">Caricamento…</td></tr>
  </tbody>
</table>

<!-- MODALE PRENOTAZIONE -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Prenota slot</h3>
    <div id="slotInfo" style="font-size:14px;margin-bottom:6px;"></div>

    <label>Nome e cognome
      <input id="fullName" placeholder="Es. Mario Rossi">
    </label>

    <label>Email
      <input id="email" type="email" placeholder="nome.cognome@esempio.it">
    </label>

    <label>Gruppo
      <select id="group">
        <option>E secondo grado</option><option>F secondo grado</option>
      </select>
    </label>

    <div class="actions">
      <button id="cancelBtn" type="button">Annulla</button>
      <button id="confirmBtn" type="button">Conferma</button>
    </div>

    <div class="status" id="modalStatus"></div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzAsv3Xb_4ybrHmBv3ZR3nw0J0QuCRypAfMkGlYlyR0Qgyuqxzlkt44bEY19T5i1hO1/exec";

let selectedRow = null;

const table = document.getElementById("slots");
const tbody = table.querySelector("tbody");
const modal = document.getElementById("modal");
const slotInfo = document.getElementById("slotInfo");
const modalStatus = document.getElementById("modalStatus");
const fullNameInput = document.getElementById("fullName");
const emailInput = document.getElementById("email");
const groupSelect = document.getElementById("group");
const confirmBtn = document.getElementById("confirmBtn");
const cancelBtn = document.getElementById("cancelBtn");
const cacheNote = document.getElementById("cacheNote");

// Escape HTML via createElement (robusto + compatibile)
const _escDiv = document.createElement("div");
function escapeHtml(s) {
  _escDiv.textContent = (s == null) ? "" : String(s);
  return _escDiv.innerHTML;
}

function groupLetter(g) {
  if (!g) return "";
  g = String(g).toUpperCase();
  if (g.startsWith("E")) return "E";
  if (g.startsWith("F")) return "F";
  return "";
}

function webexLink(url) {
  if (!url) return "—";
  const safe = escapeHtml(url);
  return `<a href="${safe}" target="_blank" rel="noopener noreferrer">Vai alla stanza Webex per lo sportello</a>`;
}

function formatDateIT(dateStr) {
  // atteso: YYYY-MM-DD
  if (!dateStr || String(dateStr).indexOf("-") === -1) return dateStr;
  const parts = String(dateStr).split("-");
  if (parts.length !== 3) return dateStr;
  const y = parts[0], m = parts[1], d = parts[2];
  return `${d}/${m}/${y}`;
}

// Rendering super-rapido: costruisce tutte le righe in una sola volta
function renderSlots(slots, fromCache=false, cacheAgeMs=0) {
  if (!Array.isArray(slots) || slots.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4">Nessuno slot disponibile.</td></tr>`;
    cacheNote.style.display = "none";
    return;
  }

  const now = new Date();
  let html = "";

  for (const s of slots) {
    const slotDT = new Date(String(s.date) + "T" + String(s.time || "00:00"));
    const hoursDiff = (slotDT - now) / 36e5;

    const isExpired =
      String(s.status || "").toUpperCase() === "OCCUPATO" &&
      hoursDiff <= 24 &&
      !s.group; // scaduto se entro 24h e non prenotato (group vuoto)

    const isBooked =
      String(s.status || "").toUpperCase() === "OCCUPATO" && !isExpired;

    let statoText = "";
    let statoClass = "";
    let actionHtml = "—";

    if (isExpired) {
      statoText = "Scaduto";
      statoClass = "stato-scaduto";
      actionHtml = "—";
    } else if (isBooked) {
      const nome = s.name ? " – " + escapeHtml(s.name) : "";
      statoText = "Occupato – " + escapeHtml(groupLetter(s.group)) + nome;
      statoClass = "stato-occupato";
      actionHtml = webexLink(s.webex);
    } else {
      statoText = "Prenotabile";
      statoClass = "stato-libero";
      actionHtml = `<button type="button" data-row="${escapeHtml(s.row)}" data-label="${escapeHtml(formatDateIT(s.date))} ${escapeHtml(s.time)}">Prenota</button>`;
    }

    html += `
      <tr>
        <td>${escapeHtml(formatDateIT(s.date))}</td>
        <td>${escapeHtml(s.time)}</td>
        <td class="${statoClass}">${statoText}</td>
        <td>${actionHtml}</td>
      </tr>
    `;
  }

  tbody.innerHTML = html;

  // Attacca handler ai bottoni
  tbody.querySelectorAll("button[data-row]").forEach(b => {
    b.addEventListener("click", () => openModal(b.dataset.row, b.dataset.label));
  });

  if (fromCache) {
    const sec = Math.max(1, Math.round(cacheAgeMs / 1000));
    cacheNote.textContent = `Mostro una copia rapida (cache) di Prenotazione sportello TIC di Carlotta Borghetti. Aggiornamento in corso… (cache: ${sec}s)`;
    cacheNote.style.display = "block";
  } else {
    cacheNote.style.display = "none";
  }
}

function openModal(row, label) {
  selectedRow = parseInt(row, 10);
  slotInfo.textContent = "Stai prenotando: " + label;
  modalStatus.textContent = "";
  modalStatus.className = "status";
  fullNameInput.value = "";
  emailInput.value = "";
  groupSelect.selectedIndex = 0;
  modal.style.display = "flex";
  fullNameInput.focus();
}

function closeModal() {
  modal.style.display = "none";
  confirmBtn.disabled = false;
  confirmBtn.textContent = "Conferma";
  selectedRow = null;
}

function confirmBooking() {
  const fullName = fullNameInput.value.trim();
  const email = emailInput.value.trim();
  const group = groupSelect.value;

  if (!fullName || !email) {
    modalStatus.textContent = "Compila tutti i campi";
    modalStatus.className = "status error";
    return;
  }

  confirmBtn.disabled = true;
  confirmBtn.textContent = "Invio…";

  fetch(API, {
    method: "POST",
    body: JSON.stringify({ row: selectedRow, fullName, email, group })
  })
  .then(r => r.json())
  .then(res => {
    if (res && res.ok) {
      modalStatus.textContent = "Prenotazione confermata";
      modalStatus.className = "status ok";
      setTimeout(() => { closeModal(); loadSlots(true); }, 350);
    } else {
      modalStatus.textContent = (res && res.error) ? res.error : "Errore";
      modalStatus.className = "status error";
      confirmBtn.disabled = false;
      confirmBtn.textContent = "Conferma";
    }
  })
  .catch(() => {
    modalStatus.textContent = "Errore di rete";
    modalStatus.className = "status error";
    confirmBtn.disabled = false;
    confirmBtn.textContent = "Conferma";
  });
}

const CACHE_KEY = "slots_cache_v1_" + API;
function readCache() {
  try {
    const raw = localStorage.getItem(CACHE_KEY);
    if (!raw) return null;
    return JSON.parse(raw);
  } catch {
    return null;
  }
}
function writeCache(slots) {
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), slots }));
  } catch {
    // ignore
  }
}

function loadSlots(softRefresh=false) {
  // softRefresh=true: lascia tabella com'è e aggiorna in background
  if (!softRefresh) {
    tbody.innerHTML = `<tr class="loading-row"><td colspan="4">Caricamento…</td></tr>`;
  }

  fetch(API + "?action=list")
    .then(r => r.json())
    .then(data => {
      const slots = (data && data.slots) ? data.slots : [];
      writeCache(slots);
      renderSlots(slots, false, 0);
    })
    .catch(err => {
      console.error(err);
      const cached = readCache();
      if (cached && Array.isArray(cached.slots)) {
        renderSlots(cached.slots, true, Date.now() - (cached.ts || Date.now()));
      } else {
        tbody.innerHTML = `<tr><td colspan="4">Errore nel caricamento: ${escapeHtml(err.message || err)}</td></tr>`;
      }
    });
}

// UX "istantanea":
// 1) Se c'è cache, renderizza subito (0ms) e poi aggiorna
// 2) Se non c'è cache, lascia il placeholder "Caricamento…"
(function init() {
  const cached = readCache();
  if (cached && Array.isArray(cached.slots) && cached.slots.length) {
    renderSlots(cached.slots, true, Date.now() - (cached.ts || Date.now()));
    // aggiorna subito dopo il primo paint
    requestAnimationFrame(() => loadSlots(true));
  } else {
    loadSlots(false);
  }
})();

cancelBtn.addEventListener("click", closeModal);
confirmBtn.addEventListener("click", confirmBooking);
modal.addEventListener("click", e => { if (e.target === modal) closeModal(); });
document.addEventListener("keydown", e => { if (e.key === "Escape" && modal.style.display === "flex") closeModal(); });
</script>

</body>
</html>
